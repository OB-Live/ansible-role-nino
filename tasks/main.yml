---

- name: "Init logs"
  shell: | 
    echo "============ NÄ¬NO Exec Log ============ " > exec.log
    echo "=                                     = " >> exec.log
    echo "==== from {{ source_db }} " >> exec.log
    echo "====== to {{ target_db }} " >> exec.log
    echo "====== at $(date '+%d/%m/%Y %H:%M:%S')  " >> exec.log
    echo "=                                     = " >> exec.log
  args:
    executable: /bin/bash

- include_tasks: connect.yml

- include_tasks: truncate.yml
  loop: "{{ entities }}"
  vars: 
    idName: "{{ item.name }}"

- name: Iterate over entities
  include_tasks: pipeline.yml
  loop: "{{ entities }}" 
  vars: 
    idName: "{{ item.name }}"
    id_json: "{{ item.id_json }}"
    id_mask: "{{ item.id_mask if item.id_mask is defined else '' }}" 
    yaml_mask: "{{ item.yaml_mask if item.yaml_mask is defined else '' }}"

- name: "LINO check target : {{ item.name }}" 
  shell: |
    echo "$ lino pull target -i {{ descriptor }} " >> exec.log
    lino pull target -i {{ descriptor }} >> exec.log
  args:
    executable: /bin/bash
  vars: 
    descriptor: "{{ workspace }}/target/{{ item.name }}-descriptor.yml"
  loop: "{{ entities }}"

# Post processing
- include_tasks: diff.yml



# - include_tasks: cleanup.yml
#   ignore_errors: true